##########################################################
#### ビルドステージ
FROM node:20 as builder
WORKDIR /work

# ビルド用の依存パッケージをインストール
COPY package*.json ./
RUN npm install

# TypeScript コードをコピーしてビルド
COPY tsconfig.json ./
COPY ./src ./src
RUN npm run build

##########################################################
#### 実行用イメージの作成
FROM node:20 as runner
WORKDIR /work

### 環境変数
ARG NODE_ENV
ENV NODE_ENV ${NODE_ENV}

ARG TZ
ENV TZ ${TZ}

ARG ENV
ENV ENV ${ENV}

ARG PORT
ENV PORT ${PORT}

ARG SERVICE_NAME
ENV SERVICE_NAME ${SERVICE_NAME}
ARG DOMAIN
ENV DOMAIN ${DOMAIN}

ARG APP_URL
ENV APP_URL ${APP_URL}
ARG CLIENT_URL
ENV CLIENT_URL ${CLIENT_URL}

ARG USE_AUTH
ENV USE_AUTH ${USE_AUTH}
ARG IS_AUTH
ENV IS_AUTH ${IS_AUTH}

ARG CALIL_URL
ENV CALIL_URL ${CALIL_URL}
ARG CALIL_APP_KEY
ENV CALIL_APP_KEY ${CALIL_APP_KEY}

ARG SINKAN_NET_ICAL
ENV SINKAN_NET_ICAL ${SINKAN_NET_ICAL}

ARG DISCORD_URL_CHECK_LIBRARY
ENV DISCORD_URL_CHECK_LIBRARY ${DISCORD_URL_CHECK_LIBRARY}
ARG DISCORD_URL_NEW_BOOK_DISCOVER
ENV DISCORD_URL_NEW_BOOK_DISCOVER ${DISCORD_URL_NEW_BOOK_DISCOVER}

ARG FIREBASE_API_KEY
ENV FIREBASE_API_KEY ${FIREBASE_API_KEY}
ARG FIREBASE_APP_ID
ENV FIREBASE_APP_ID ${FIREBASE_APP_ID}
ARG FIREBASE_AUTH_DOMAIN
ENV FIREBASE_AUTH_DOMAIN ${FIREBASE_AUTH_DOMAIN}
ARG FIREBASE_PROJECT_ID
ENV FIREBASE_PROJECT_ID ${FIREBASE_PROJECT_ID}
ARG FIREBASE_STORAGE_BUCKET
ENV FIREBASE_STORAGE_BUCKET ${FIREBASE_STORAGE_BUCKET}
ARG FIREBASE_MESSAGING_SENDER_ID
ENV FIREBASE_MESSAGING_SENDER_ID ${FIREBASE_MESSAGING_SENDER_ID}

ARG NDL_SEARCH_URL
ENV NDL_SEARCH_URL ${NDL_SEARCH_URL}

ARG FIRESTORE_EMULATOR_HOST
ENV FIRESTORE_EMULATOR_HOST ${FIRESTORE_EMULATOR_HOST}
ARG FIRESTORE_EMULATOR_PORT
ENV FIRESTORE_EMULATOR_PORT ${FIRESTORE_EMULATOR_PORT}
ARG GOOGLE_APPLICATION_CREDENTIALS
ENV GOOGLE_APPLICATION_CREDENTIALS ${GOOGLE_APPLICATION_CREDENTIALS}

EXPOSE 8080

# 本番環境用のパッケージをインストール
COPY package*.json ./
RUN npm install --omit=dev && npm cache clean --force

# builder からビルド結果だけコピー
COPY --from=builder /work/dist ./dist
# devの場合だけcredentials.jsonファイルを使う
COPY bookutil-c843f04a0bfd.json ./


# Node.js アプリを起動
CMD ["node", "./dist/app.js"]